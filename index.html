<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Flappy Bird Deluxe</title>
  <style>
    body { margin:0; overflow:hidden; font-family:sans-serif; background:#222; color:white; }
    canvas { display:block; margin:0 auto; background:skyblue; }

    .overlay {
      position:absolute;
      top:0; left:0;
      width:100%; height:100%;
      display:flex;
      justify-content:center;
      align-items:center;
      background:rgba(0,0,0,0.7);
      z-index:10;
      flex-direction:column;
      color:white;
      text-align:center;
      padding:20px;
    }
    .overlay button {
      margin-top:15px;
      padding:10px 20px;
      border:none;
      border-radius:8px;
      background:#ffcc00;
      font-size:16px;
      cursor:pointer;
    }
    .close-btn {
      position:absolute;
      top:10px;
      right:20px;
      background:#ff4444;
      border:none;
      border-radius:50%;
      width:30px; height:30px;
      color:white;
      font-weight:bold;
      cursor:pointer;
    }
    #hud {
      position:absolute;
      top:10px;
      left:10px;
      font-size:20px;
      background:rgba(0,0,0,0.3);
      padding:5px 10px;
      border-radius:8px;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="480" height="640"></canvas>

  <div id="hud">MÃ¼nzen: <span id="coins">0</span> | Highscore: <span id="highscore">0</span></div>

  <!-- Intro Overlay -->
  <div id="introOverlay" class="overlay">
    <button class="close-btn" id="closeIntroBtn">X</button>
    <h1>Willkommen zu Flappy Bird Deluxe ðŸŽ‰</h1>
    <p>DrÃ¼cke die <b>Leertaste</b>, um loszufliegen!</p>
    <p>Mit <b>S</b> Ã¶ffnest/schlieÃŸt du den Shop.<br>Mit <b>P</b> pausierst du.<br>Mit <b>M</b> schaltest du Musik an/aus.</p>
    <button id="startBtn">OK, los gehtâ€™s!</button>
  </div>

  <!-- Shop Overlay -->
  <div id="shopOverlay" class="overlay" style="display:none">
    <button class="close-btn" id="closeShopBtn">X</button>
    <h2>ðŸ›’ Shop</h2>
    <p>Kaufe Skins mit deinen MÃ¼nzen!</p>
    <ul id="shopItems"></ul>
  </div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    // ===== Game state =====
    let gameRunning = false;
    let paused = false;
    let showIntro = true;
    let showShop = false;

    // Bird
    let birdY = canvas.height/2;
    let birdVY = 0;
    const gravity = 0.5;
    const flapStrength = -8;
    const birdX = 100;

    // Pipes
    let pipes = [];
    const pipeGap = 140;
    const pipeWidth = 60;
    let pipeSpeed = 2.5;
    let frameCount = 0;

    // Coins & Score
    let coins = parseInt(localStorage.getItem("coins")||"0");
    let highscore = parseInt(localStorage.getItem("highscore")||"0");
    let score = 0;

    // Skins
    const skins = [
      {name:"Classic", color:"yellow", price:0},
      {name:"Sunset", color:"orange", price:10},
      {name:"Neon", color:"lime", price:20},
      {name:"Forest", color:"green", price:30},
      {name:"Void", color:"purple", price:50}
    ];
    let ownedSkins = JSON.parse(localStorage.getItem("ownedSkins")||"[\"Classic\"]");
    let activeSkin = localStorage.getItem("activeSkin")||"Classic";

    // Audio (optional simple beeps)
    function playBeep(freq){
      try{
        const ctxAudio = new (window.AudioContext||window.webkitAudioContext)();
        const osc = ctxAudio.createOscillator();
        const gain = ctxAudio.createGain();
        osc.type = "square";
        osc.frequency.setValueAtTime(freq, ctxAudio.currentTime);
        gain.gain.setValueAtTime(0.05, ctxAudio.currentTime);
        osc.connect(gain);
        gain.connect(ctxAudio.destination);
        osc.start();
        osc.stop(ctxAudio.currentTime+0.1);
      } catch(e) {}
    }

    // ===== Rendering =====
    function drawBird(){
      ctx.fillStyle = skins.find(s=>s.name===activeSkin).color;
      ctx.beginPath();
      ctx.arc(birdX,birdY,20,0,Math.PI*2);
      ctx.fill();
    }

    function drawPipes(){
      ctx.fillStyle = "green";
      pipes.forEach(pipe => {
        ctx.fillRect(pipe.x,0,pipeWidth,pipe.top);
        ctx.fillRect(pipe.x,pipe.top+pipeGap,pipeWidth,canvas.height);
        if(pipe.coin){
          ctx.fillStyle="gold";
          ctx.beginPath();
          ctx.arc(pipe.x+pipeWidth/2,pipe.top+pipeGap/2,10,0,Math.PI*2);
          ctx.fill();
          ctx.fillStyle="green";
        }
      });
    }

    function resetGame(){
      birdY = canvas.height/2;
      birdVY = 0;
      pipes=[];
      score=0;
      frameCount=0;
    }

    // ===== Game Loop =====
    function gameLoop(){
      ctx.clearRect(0,0,canvas.width,canvas.height);

      if(gameRunning && !paused){
        frameCount++;

        // Bird physics
        birdVY += gravity;
        birdY += birdVY;

        // Pipes logic
        if(frameCount%100===0){
          const top = Math.random()* (canvas.height- pipeGap-100)+50;
          pipes.push({x:canvas.width, top:top, coin:true});
        }
        pipes.forEach(pipe=>{
          pipe.x -= pipeSpeed;
        });
        pipes = pipes.filter(p=>p.x+pipeWidth>0);

        // Collisions
        pipes.forEach(pipe=>{
          if(birdX+20>pipe.x && birdX-20<pipe.x+pipeWidth){
            if(birdY-20<pipe.top || birdY+20>pipe.top+pipeGap){
              gameRunning=false;
              if(score>highscore){
                highscore=score;
                localStorage.setItem("highscore",highscore);
              }
            }
          }
          // coin collect
          if(pipe.coin && birdX>pipe.x && birdX<pipe.x+pipeWidth && Math.abs(birdY-(pipe.top+pipeGap/2))<20){
            coins++;
            playBeep(600);
            pipe.coin=false;
            localStorage.setItem("coins",coins);
          }
        });

        if(birdY>canvas.height||birdY<0){
          gameRunning=false;
        }

        // Score update
        if(frameCount%50===0){
          score++;
        }
      }

      drawPipes();
      drawBird();

      document.getElementById("coins").innerText=coins;
      document.getElementById("highscore").innerText=highscore;

      requestAnimationFrame(gameLoop);
    }

    gameLoop();

    // ===== Shop =====
    const shopOverlay = document.getElementById("shopOverlay");
    const shopItems = document.getElementById("shopItems");

    function renderShop(){
      shopItems.innerHTML="";
      skins.forEach(skin=>{
        const li=document.createElement("li");
        if(ownedSkins.includes(skin.name)){
          li.innerHTML=`${skin.name} <button ${skin.name===activeSkin?"disabled":""}>${skin.name===activeSkin?"Aktiv":"Aktivieren"}</button>`;
          li.querySelector("button").onclick=()=>{
            activeSkin=skin.name;
            localStorage.setItem("activeSkin",activeSkin);
            renderShop();
          };
        } else {
          li.innerHTML=`${skin.name} - ${skin.price} MÃ¼nzen <button>Kaufen</button>`;
          li.querySelector("button").onclick=()=>{
            if(coins>=skin.price){
              coins-=skin.price;
              ownedSkins.push(skin.name);
              localStorage.setItem("coins",coins);
              localStorage.setItem("ownedSkins",JSON.stringify(ownedSkins));
              renderShop();
            } else {
              alert("Nicht genug MÃ¼nzen!");
            }
          };
        }
        shopItems.appendChild(li);
      });
    }

    // ===== Overlay Controls =====
    const introOverlay = document.getElementById("introOverlay");
    function startGame(){
      showIntro=false;
      introOverlay.style.display="none";
      gameRunning=true;
      resetGame();
    }
    function toggleShop(){
      if(showShop){
        showShop=false;
        shopOverlay.style.display="none";
      } else {
        showShop=true;
        renderShop();
        shopOverlay.style.display="flex";
      }
    }

    document.getElementById("startBtn").onclick=startGame;
    document.getElementById("closeIntroBtn").onclick=startGame;
    document.getElementById("closeShopBtn").onclick=()=>{
      showShop=false;
      shopOverlay.style.display="none";
    };

    // ===== Keyboard =====
    document.addEventListener("keydown", (e)=>{
      if(e.code==="Space"){
        if(showIntro){ startGame(); }
        else if(!showShop){ birdVY=flapStrength; playBeep(400);} 
      }
      if(e.code==="KeyS" && !showIntro){ toggleShop(); }
      if(e.code==="KeyP"){ paused=!paused; }
      if(e.code==="Escape"){
        showIntro=false; introOverlay.style.display="none";
        showShop=false; shopOverlay.style.display="none";
      }
    });

    // Mobile Touch
    canvas.addEventListener("touchstart",()=>{
      if(showIntro){ startGame(); }
      else if(!showShop){ birdVY=flapStrength; }
    });
  </script>
</body>
</html>
      // coin
      pctx.fillStyle=s.coin; pctx.beginPath(); pctx.arc(110,18,6,0,Math.PI*2); pctx.fill();
      thumb.appendChild(pv);

      const name = document.createElement('div'); name.className='name'; name.textContent = s.name;
      const meta = document.createElement('div'); meta.className='meta muted'; meta.textContent = unlockedFlag? 'Freigeschaltet' : `Preis: ${s.price} ðŸª™`;
      const actions = document.createElement('div'); actions.className='action';

      const btnUse = document.createElement('div'); btnUse.className='btn'; btnUse.textContent = (selectedSkin===s.id? 'Aktiv' : 'Benutzen'); btnUse.disabled = !unlockedFlag;
      btnUse.style.opacity = unlockedFlag? 1 : .45; btnUse.onclick = ()=>{
        if(!unlockedFlag) return;
        selectedSkin = s.id; updateSkin(s.id); persist(); updateHUD(); renderShop();
      };

      const btnBuy = document.createElement('div'); btnBuy.className='btn secondary'; btnBuy.textContent = unlockedFlag? 'â€”' : 'Kaufen';
      btnBuy.style.pointerEvents = unlockedFlag? 'none' : 'auto';
      btnBuy.style.opacity = unlockedFlag? .5 : 1;
      btnBuy.onclick = ()=>{
        if(unlockedFlag) return; if(coins < s.price){ flashCoins(); return; }
        coins -= s.price; unlocked.add(s.id); selectedSkin=s.id; updateSkin(s.id); persist(); updateHUD(); renderShop(); beep({freq:600,dur:.12,type:'triangle',vol:0.1});
      };

      actions.appendChild(btnUse); actions.appendChild(btnBuy);
      el.appendChild(thumb); el.appendChild(name); el.appendChild(meta); el.appendChild(actions);
      storeEl.appendChild(el);
    });
  }

  function flashCoins(){
    coinsInShop.animate([{transform:'scale(1)'},{transform:'scale(1.15)'},{transform:'scale(1)'}],{duration:300});
    beep({freq:220,dur:.08,type:'square',vol:0.07});
  }

  // --- Input ---
  function onKey(e){
    if(e.repeat) return;
    if(e.code==='Space'){ e.preventDefault(); if(gameState===State.PLAY) flap(); else play(); }
    else if(e.key==='p' || e.key==='P'){ togglePause(); }
    else if(e.key==='m' || e.key==='M'){ toggleMute(); }
    else if(e.key==='s' || e.key==='S'){ openShop(); }
    else if(e.key==='h' || e.key==='H'){ openHelp(); }
    else if(e.key==='r' || e.key==='R'){ restart(); }
  }
  function onPointer(){ if(gameState===State.PLAY) flap(); else play(); }

  document.addEventListener('keydown', onKey);
  canvas.addEventListener('pointerdown', onPointer);

  // --- Controls & Menus ---
  function openShop(){ menu.hidden=true; help.hidden=true; shop.hidden=false; renderShop(); updateHUD(); }
  function openHelp(){ help.hidden=false; menu.hidden=true; shop.hidden=true; }
  function closeShop(){ shop.hidden=true; menu.hidden=false; }
  function closeHelp(){ help.hidden=true; menu.hidden=false; }
  function togglePause(){
    if(gameState===State.PLAY){ gameState=State.PAUSE; menu.hidden=false; }
    else if(gameState===State.PAUSE){ gameState=State.PLAY; menu.hidden=true; }
  }
  function toggleMute(){ audioEnabled=!audioEnabled; btnMute.textContent = audioEnabled? 'ðŸ”Š':'ðŸ”ˆ'; }
  function restart(){ reset(); gameState=State.PLAY; menu.hidden=true; }

  btnPlay.addEventListener('click', play);
  btnOpenShop.addEventListener('click', openShop);
  btnCloseShop.addEventListener('click', closeShop);
  btnPause.addEventListener('click', togglePause);
  btnMute.addEventListener('click', toggleMute);
  btnShop.addEventListener('click', openShop);
  btnHelp.addEventListener('click', openHelp);
  btnCloseHelp.addEventListener('click', closeHelp);
})();
</script>
</body>
</html>
